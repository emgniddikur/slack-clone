# SQLで木構造を扱う(閉包テーブル)

## はじめに

SQLを使用して、ディレクトリやNotionアプリのページのような木構造で以下の機能を実装したい。

- 取得
  - ルートの一覧の取得
  - 子の一覧の取得
  - 先祖の一覧の取得
  - 子孫の一覧の取得
- 追加
- 削除
- 移動
  - 先祖-子孫間、兄弟間の移動

今回は閉包テーブル(Closure Table)というデータ構造で実装していく。

## 閉包テーブルとは

閉包テーブルとは、木構造内の各ノードにおいて、先祖-子孫間の関係(自身も含む)を格納するテーブルのことである。

例えば以下のような木構造がある場合、

- 1
  - 1-1
    - 1-1-1
  - 1-2
  - 1-3
- 2
- 3

閉包テーブルは以下のようになる。

| ancestor | descendant | weight |
| -------- | ---------- | ------ |
| 1        | 1          | 0      |
| 1        | 1-1        | 1      |
| 1        | 1-2        | 1      |
| 1        | 1-3        | 1      |
| 1        | 1-1-1      | 2      |
| 2        | 2          | 0      |
| 3        | 3          | 0      |
| 1-1      | 1-1        | 0      |
| 1-1      | 1-1-1      | 1      |
| 1-2      | 1-2        | 0      |
| 1-3      | 1-3        | 0      |
| 1-1-1    | 1-1-1      | 0      |
